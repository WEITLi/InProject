# 系统架构说明

## 🏗️ 整体架构图

```
内部威胁检测特征提取系统 - 模块化架构

┌─────────────────────────────────────────────────────────────────┐
│                        输入层 (Input Layer)                      │
├─────────────────────────────────────────────────────────────────┤
│  事件数据 (Events)        │        用户数据 (Users)              │
│  ┌─────────────────┐     │     ┌─────────────────────┐         │
│  │ type, date,     │     │     │ role, dept,         │         │
│  │ user, pc,       │     │     │ ITAdmin, OCEAN,     │         │
│  │ content, ...    │     │     │ pc_type, ...        │         │
│  └─────────────────┘     │     └─────────────────────┘         │
└─────────────────────────────────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────┐
│                      核心编码层 (Core Encoding)                   │
├─────────────────────────────────────────────────────────────────┤
│                    EventEncoder (core_logic/encoder.py)        │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │               统一事件编码接口                               │ │
│  │  • fit() - 拟合编码器参数                                   │ │
│  │  • encode_event() - 编码单个事件                            │ │
│  │  • encode_event_sequence() - 编码事件序列                   │ │
│  │  • 版本兼容处理 (r4.2/r5.2/r6.2)                           │ │
│  │  • mask机制处理缺失数据                                     │ │
│  └─────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────┐
│                    特征提取层 (Feature Extraction)                │
├─────────────────────────────────────────────────────────────────┤
│ ┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ┌──────────────┐ │
│ │   时间特征   │ │  用户上下文   │ │   事件特征   │ │   工具模块   │ │
│ │             │ │             │ │             │ │             │ │
│ │core_logic/  │ │core_logic/  │ │core_logic/  │ │core_logic/  │ │
│ │temporal.py  │ │user_context.│ │email.py     │ │  utils.py   │ │
│ │            │ │py           │ │file.py      │ │             │ │
│ │• 工作时间   │ │• 角色层级    │ │http.py      │ │• 标准化器   │ │
│ │• 会话时长   │ │• 部门权限    │ │device.py    │ │• 编码器     │ │
│ │• 时间模式   │ │• OCEAN特征  │ │• 领域专用   │ │• 分箱工具   │ │
│ │• 周期编码   │ │• 风险画像    │ │• 异常检测   │ │• 文本处理   │ │
│ └──────────────┘ └──────────────┘ └──────────────┘ └──────────────┘ │
└─────────────────────────────────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────┐
│                      输出层 (Output Layer)                       │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐ │
│  │   特征向量      │     │   mask向量      │     │   风险评分      │ │
│  │                │     │                │     │                │ │
│  │ 固定长度数值向量 │     │ 布尔掩码标记     │     │ 异常模式评分     │ │
│  │ (默认256维)     │     │ 有效/缺失特征    │     │ (0.0-1.0)      │ │
│  └─────────────────┘     └─────────────────┘     └─────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

## 🔧 数据流图

```
数据处理流程 (Data Processing Pipeline)

原始事件 → 数据预处理 → 特征提取 → 向量化 → 输出
    │           │           │          │        │
    │           │           │          │        ▼
    │           │           │          │   ┌─────────────┐
    │           │           │          │   │ 固定长度向量 │
    │           │           │          │   │ + mask     │
    │           │           │          │   │ + 风险评分  │
    │           │           │          │   └─────────────┘
    │           │           │          │
    │           │           │          ▼
    │           │           │     ┌──────────────┐
    │           │           │     │   维度调整    │
    │           │           │     │ • 填充/截断   │
    │           │           │     │ • 标准化     │
    │           │           │     └──────────────┘
    │           │           │
    │           │           ▼
    │           │      ┌─────────────────┐
    │           │      │   特征拼接       │
    │           │      │ • 时间特征      │
    │           │      │ • 用户特征      │
    │           │      │ • 事件特征      │
    │           │      │ • 类型特征      │
    │           │      └─────────────────┘
    │           │
    │           ▼
    │      ┌──────────────────┐
    │      │    数据清洗       │
    │      │ • 时间戳解析      │
    │      │ • 缺失值处理      │
    │      │ • 格式标准化      │
    │      └──────────────────┘
    │
    ▼
┌───────────────────────┐
│      原始数据          │
│ • 事件记录 (CSV/JSON)  │
│ • 用户信息 (CSV)      │
│ • 多种格式时间戳       │
│ • 不同版本字段        │
└───────────────────────┘
```

## 🧩 模块依赖关系

```
模块依赖图 (Module Dependencies)

                    core_logic/encoder.py (核心)
                         │
        ┌────────────────┼────────────────┐
        │                │                │
        ▼                ▼                ▼
core_logic/temporal.py core_logic/user_context.py core_logic/[event_modules]
        │                │                │
        │                │                ├── core_logic/email.py
        │                │                ├── core_logic/file.py
        │                │                ├── core_logic/http.py
        │                │                └── core_logic/device.py
        │                │                │
        └────────────────┼────────────────┘
                         │
                         ▼
                    core_logic/utils.py (基础)
                         │
                    ┌────┴────┐
                    ▼         ▼
        core_logic/FeatureEncoder  工具函数
              
依赖层级:
Level 1: core_logic/utils.py (基础工具层)
Level 2: core_logic/temporal.py, core_logic/user_context.py, core_logic/email.py, etc. (特征提取层)  
Level 3: core_logic/encoder.py (统一接口层)
```

## 📊 特征向量结构

```
特征向量组成 (Feature Vector Composition)

┌─────────────────────────────────────────────────────────────────────┐
│                     256维特征向量 (默认)                              │
├─────────────────────────────────────────────────────────────────────┤
│ 事件类型 │  时间特征  │ 用户上下文 │ 邮件特征 │ 文件特征 │ HTTP │ 设备 │ 填充 │
│  (6维)  │   (12维)   │   (10维)   │  (9维)  │  (5维)  │(5维) │(2维)│ ... │
├─────────────────────────────────────────────────────────────────────┤
│    0-5   │   6-17    │   18-27    │  28-36  │  37-41  │42-46 │47-48│49-255│
└─────────────────────────────────────────────────────────────────────┘

版本特征差异:
• r4.2: 基础特征集
• r5.2: +邮件附件详情 +文件USB传输 +设备内容
• r6.2: +HTTP活动类型

mask向量:
┌─────────────────────────────────────────────────────────────────────┐
│                     256维布尔掩码                                     │
├─────────────────────────────────────────────────────────────────────┤
│ True表示对应特征有效, False表示缺失或无效                              │
│ 用于指导模型忽略无效特征                                              │
└─────────────────────────────────────────────────────────────────────┘
```

## 🔄 处理流程详解

### 1. 初始化阶段
```python
# from feature_extraction_scenario.core_logic.encoder import EventEncoder # 示例导入
encoder = EventEncoder(feature_dim=256, data_version='r4.2')
# 1. 设置特征维度配置
# 2. 创建各子模块的特征编码器
# 3. 初始化事件类型映射
```

### 2. 拟合阶段
```python
encoder.fit(events_df, users_df)
# 1. 分析事件数据统计信息
# 2. 拟合数值特征标准化器
# 3. 拟合分类特征编码器
# 4. 构建词汇表和embedding
```

### 3. 编码阶段
```python
features, mask = encoder.encode_event(event_dict, user_context)
# 1. 事件类型识别和one-hot编码
# 2. 时间特征提取和标准化
# 3. 用户上下文特征编码
# 4. 特定事件类型特征提取
# 5. 特征拼接和维度调整
# 6. 生成对应的mask向量
```

## ⚙️ 配置管理

### 特征维度配置
```python
# core_logic/encoder.py中的_get_feature_dimensions()方法
def _get_feature_dimensions(self) -> Dict[str, int]:
    if self.data_version in ['r4.1', 'r4.2']:
        return {
            'temporal': 12,     # 时间特征
            'user_context': 10, # 用户上下文
            'email': 9,         # 邮件特征 
            'file': 5,          # 文件特征
            'http': 5,          # HTTP特征
            'device': 2,        # 设备特征
            'event_type': 6,    # 事件类型
            'activity': 20      # 活动特征
        }
    # ... 其他版本配置
```

### 事件类型映射
```python
# core_logic/encoder.py中的事件类型映射
self.event_type_mapping = {
    'logon': 1,
    'device': 2, 
    'email': 3,
    'file': 4,
    'http': 5
}
```

## 🔍 异常检测架构

```
异常检测子系统 (Anomaly Detection Subsystem)

输入事件流 → 模式分析 → 风险评分 → 异常告警
     │           │          │          │
     │           │          │          ▼
     │           │          │    ┌──────────────┐
     │           │          │    │  风险等级     │
     │           │          │    │ • 低风险     │
     │           │          │    │ • 中风险     │
     │           │          │    │ • 高风险     │
     │           │          │    └──────────────┘
     │           │          │
     │           │          ▼
     │           │    ┌─────────────────┐
     │           │    │   综合评分       │
     │           │    │ • 邮件风险 30%   │
     │           │    │ • HTTP风险 30%   │
     │           │    │ • 文件风险 20%   │
     │           │    │ • 用户风险 20%   │
     │           │    └─────────────────┘
     │           │
     │           ▼
     │      ┌─────────────────────────┐
     │      │      模式识别            │
     │      │ ┌─────────────────────┐ │
     │      │ │ 邮件异常模式        │ │
     │      │ │ • 大量外部邮件      │ │
     │      │ │ • 可执行附件        │ │
     │      │ │ • 异常大邮件        │ │
     │      │ └─────────────────────┘ │
     │      │ ┌─────────────────────┐ │
     │      │ │ HTTP异常模式        │ │
     │      │ │ • 高风险域名访问    │ │
     │      │ │ • 大量下载/上传     │ │
     │      │ │ • IP地址直接访问    │ │
     │      │ └─────────────────────┘ │
     │      │ ┌─────────────────────┐ │
     │      │ │ 文件异常模式        │ │
     │      │ │ • 大量可执行文件    │ │
     │      │ │ • USB频繁传输       │ │
     │      │ │ • 系统文件访问      │ │
     │      │ └─────────────────────┘ │
     │      │ ┌─────────────────────┐ │
     │      │ │ 时间异常模式        │ │
     │      │ │ • 非工作时间活动    │ │
     │      │ │ • 异常长会话        │ │
     │      │ │ • 周末大量工作      │ │
     │      │ └─────────────────────┘ │
     │      └─────────────────────────┘
     │
     ▼
┌────────────────────────┐
│     事件分类            │
│ • email_events         │
│ • http_events          │ 
│ • file_events          │
│ • device_events        │
│ • temporal_patterns    │
└────────────────────────┘
```

## 🚀 扩展性设计

### 新特征模块添加流程
1. 创建新模块文件 `new_feature.py`
2. 实现标准接口:
   ```python
   def encode_new_features(event_dict, feature_encoder, data_version):
       # 特征提取逻辑
       return features, mask
   ```
3. 在 `encoder.py` 中集成:
   ```python
   from .new_feature import encode_new_features
   
   # 在encode_event方法中添加调用
   if event_type == 'new_type':
       event_features, event_mask = encode_new_features(...)
   ```
4. 更新特征维度配置
5. 添加对应的异常检测函数

### 新数据版本支持
1. 在 `_get_feature_dimensions()` 中添加新版本配置
2. 在各模块中添加版本特定的处理逻辑
3. 更新文档和示例代码

## 📈 性能优化策略

### 内存优化
- 使用numpy数组进行向量化计算
- 分批处理大量事件
- 及时释放不需要的中间结果

### 计算优化  
- 缓存编码器状态避免重复拟合
- 预计算常用特征变换
- 使用向量化操作替代循环

### 存储优化
- 支持编码器状态序列化
- 压缩存储大型特征矩阵
- 增量更新机制

---

该架构设计确保了系统的**模块化**、**可扩展性**和**版本兼容性**，为内部威胁检测提供了强大而灵活的特征提取基础设施。 