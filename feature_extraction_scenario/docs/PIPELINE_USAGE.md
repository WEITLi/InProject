# CERTæ•°æ®é›†å®Œæ•´ç‰¹å¾æå–æµæ°´çº¿ä½¿ç”¨æŒ‡å—

## ğŸ”’ æ•°æ®å®‰å…¨è­¦å‘Š

> **âš ï¸ é‡è¦æé†’**: æœ¬æµæ°´çº¿ä¼šæ“ä½œCSVæ•°æ®æ–‡ä»¶ï¼Œè¯·åœ¨ä½¿ç”¨å‰é˜…è¯» [`./DATA_SAFETY_GUIDE.md`](./DATA_SAFETY_GUIDE.md) (åŒç›®å½•ä¸‹)
> 
> **æµ‹è¯•å»ºè®®**: 
> - ä½¿ç”¨ `../tests/test_pipeline.py` è¿›è¡Œå®‰å…¨æµ‹è¯•ï¼Œå®ƒå…·æœ‰å®Œæ•´çš„æ•°æ®ä¿æŠ¤æœºåˆ¶
> - çœŸå®æ•°æ®ç¯å¢ƒä¸‹é¦–æ¬¡è¿è¡Œå‰ï¼Œè¯·æ‰‹åŠ¨å¤‡ä»½é‡è¦æ–‡ä»¶
> - ä¼˜å…ˆåœ¨ç‹¬ç«‹ç›®å½•ä¸­æµ‹è¯•æµæ°´çº¿åŠŸèƒ½

## ğŸ¯ æ¦‚è¿°

æ–°çš„`dataset_pipeline.py`å®ç°äº†å®Œæ•´çš„CERTæ•°æ®é›†ç‰¹å¾æå–æµæ°´çº¿ï¼Œä¸åŸå§‹`feature_extraction.py`åŠŸèƒ½å¯¹ç­‰ï¼Œæ”¯æŒï¼š

- âœ… **åŸå§‹æ—¥å¿—æ•°æ®çš„æŒ‰å‘¨åˆå¹¶**
- âœ… **ç”¨æˆ·ä¿¡æ¯å’Œæ¶æ„ç”¨æˆ·æ ‡è®°çš„æå–**  
- âœ… **æ´»åŠ¨æ•°æ®çš„æ•°å€¼åŒ–ç‰¹å¾æå–**
- âœ… **å¤šç²’åº¦ç‰¹å¾çš„ç»Ÿè®¡è®¡ç®—å’ŒCSVå¯¼å‡º**
- âœ… **å‘¨çº§åˆ«/æ—¥çº§åˆ«/ä¼šè¯çº§åˆ«çš„åˆ†æ**

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„å¯¹æ¯”

### åŸå§‹ç³»ç»Ÿ vs æ–°ç³»ç»Ÿ

| åŠŸèƒ½æ¨¡å— | åŸå§‹ç³»ç»Ÿ | æ–°ç³»ç»Ÿ | çŠ¶æ€ |
|---------|----------|--------|------|
| æ•°æ®åˆå¹¶ | `combine_by_timerange_pandas()` | `step1_combine_raw_data()` | âœ… å·²å®ç° |
| ç”¨æˆ·ä¿¡æ¯ | `get_mal_userdata()` | `step2_load_user_data()` | âœ… å·²å®ç° |
| ç‰¹å¾æå– | `process_week_num()` + `f_calc()` | `step3_extract_features()` | âœ… å·²å®ç° |
| å¤šçº§åˆ«åˆ†æ | `to_csv()` | `step4_multi_level_analysis()` | âœ… å·²å®ç° |
| äº‹ä»¶ç¼–ç  | `email_process()`, `file_process()` ç­‰ | æ¨¡å—åŒ–ç³»ç»Ÿ | âœ… å·²å‡çº§ |

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ğŸ§ª å®‰å…¨æµ‹è¯•ï¼ˆæ¨èé¦–æ¬¡ä½¿ç”¨ï¼‰

```bash
# 1. å®‰å…¨æµ‹è¯•ï¼ˆæ¨èï¼‰
# å‡è®¾æ‚¨åœ¨ InProject/ ç›®å½•ä¸‹è¿è¡Œ
python feature_extraction_scenario/tests/test_pipeline.py

# ç³»ç»Ÿä¼šè‡ªåŠ¨ï¼š
# - æ£€æµ‹ç°æœ‰æ•°æ®å¹¶æä¾›ä¿æŠ¤
# - åˆ›å»ºæ ‡è®°çš„æµ‹è¯•æ•°æ®  
# - è¿è¡Œå®Œæ•´æµ‹è¯•
# - å®‰å…¨æ¸…ç†æµ‹è¯•æ–‡ä»¶
```

æµ‹è¯•ç³»ç»ŸåŠŸèƒ½ï¼š
- âœ… **æ•°æ®ä¿æŠ¤**: è‡ªåŠ¨æ£€æµ‹å¹¶ä¿æŠ¤çœŸå®æ•°æ®
- âœ… **å¤‡ä»½æœºåˆ¶**: å¯é€‰æ‹©å¤‡ä»½ç°æœ‰æ•°æ®
- âœ… **æ ‡è®°ç³»ç»Ÿ**: æµ‹è¯•æ•°æ®å¸¦æœ‰æ˜ç¡®æ ‡è®°
- âœ… **å®‰å…¨æ¸…ç†**: åªåˆ é™¤ç¡®è®¤çš„æµ‹è¯•æ–‡ä»¶

### ğŸ­ ç”Ÿäº§ç¯å¢ƒä½¿ç”¨

> **âš ï¸ æ³¨æ„**: ä»…åœ¨å……åˆ†æµ‹è¯•ååœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨

```bash
# 2. ç”Ÿäº§ç¯å¢ƒï¼ˆè°¨æ…ä½¿ç”¨ï¼‰
# å‡è®¾æ‚¨åœ¨ InProject/ ç›®å½•ä¸‹è¿è¡Œ
python feature_extraction_scenario/core_logic/dataset_pipeline.py

# ä½¿ç”¨å‰ç¡®ä¿ï¼š
# - å·²å¤‡ä»½é‡è¦æ•°æ®
# - ç†è§£è¾“å…¥è¾“å‡ºæ–‡ä»¶
# - æµ‹è¯•è¿‡ç›¸åŒé…ç½®
```

### åŸºç¡€ä½¿ç”¨

```bash
# åœ¨CERTæ•°æ®é›†ç›®å½•ä¸‹è¿è¡Œï¼ˆå¦‚r4.2æ–‡ä»¶å¤¹ï¼‰ï¼Œå‡è®¾ feature_extraction_scenario åœ¨å…¶å­ç›®å½•
cd /path/to/r4.2/

# åŸºç¡€è¿è¡Œï¼ˆå¤„ç†æ‰€æœ‰å‘¨ï¼Œæ‰€æœ‰ç”¨æˆ·ï¼Œæ‰€æœ‰æ¨¡å¼ï¼‰
python feature_extraction_scenario/core_logic/dataset_pipeline.py

# æŒ‡å®šå‚æ•°è¿è¡Œ
python feature_extraction_scenario/core_logic/dataset_pipeline.py [CPUæ ¸å¿ƒæ•°] [å¼€å§‹å‘¨] [ç»“æŸå‘¨] [æœ€å¤§ç”¨æˆ·æ•°] [æ¨¡å¼åˆ—è¡¨]
```

### å‚æ•°è¯´æ˜

```bash
# å‡è®¾ feature_extraction_scenario/core_logic/dataset_pipeline.py å¯ç›´æ¥æ‰§è¡Œæˆ–é€šè¿‡åŒ…è£…è„šæœ¬
python path_to/dataset_pipeline.py 16 0 10 100 \"week,day,session\"
#                          |  |  |   |   |
#                          |  |  |   |   â””â”€â”€ åˆ†ææ¨¡å¼ï¼ˆé€—å·åˆ†éš”ï¼‰
#                          |  |  |   â””â”€â”€â”€â”€â”€â”€ æœ€å¤§ç”¨æˆ·æ•°é™åˆ¶
#                          |  |  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ç»“æŸå‘¨æ•°
#                          |  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ å¼€å§‹å‘¨æ•°  
#                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ CPUæ ¸å¿ƒæ•°
```

## ğŸ“Š å¤šçº§åˆ«åˆ†æè¯¦è§£

### 1. å‘¨çº§åˆ«åˆ†æ (Week Level)

```python
# æ‰§è¡Œå‘¨çº§åˆ«åˆ†æ
pipeline = CERTDatasetPipeline(data_version='r4.2')
pipeline.run_full_pipeline(start_week=0, end_week=10, modes=['week'])
```

**è¾“å‡ºæ–‡ä»¶**: `WeekLevelFeatures/weeks_0_9.csv`

**ç‰¹å¾å†…å®¹**:
- ç”¨æˆ·æ¯å‘¨çš„èšåˆæ´»åŠ¨ç‰¹å¾
- äº‹ä»¶ç±»å‹åˆ†å¸ƒæ¯”ä¾‹
- ç‰¹å¾å‘é‡çš„ç»Ÿè®¡é‡ï¼ˆå‡å€¼ã€æ ‡å‡†å·®ç­‰ï¼‰
- æ¶æ„æ´»åŠ¨æ¯”ä¾‹

**æ•°æ®æ ¼å¼**:
```csv
user,week,mode,n_events,malicious_ratio,email_ratio,file_ratio,http_ratio,mean_feature_0,mean_feature_1,...
ACM2278,0,week,45,0.0,0.3,0.2,0.4,0.123,0.456,...
ACM2278,1,week,52,0.1,0.25,0.3,0.35,0.234,0.567,...
```

### 2. æ—¥çº§åˆ«åˆ†æ (Day Level)

```python
# æ‰§è¡Œæ—¥çº§åˆ«åˆ†æ
pipeline.run_full_pipeline(start_week=0, end_week=10, modes=['day'])
```

**è¾“å‡ºæ–‡ä»¶**: `DayLevelFeatures/days_0_9.csv`

**ç‰¹å¾å†…å®¹**:
- ç”¨æˆ·æ¯æ—¥çš„æ´»åŠ¨æ¨¡å¼
- å·¥ä½œæ—¥ vs å‘¨æœ«è¡Œä¸ºå·®å¼‚
- æ—¥å†…æ´»åŠ¨åˆ†å¸ƒ

**æ•°æ®æ ¼å¼**:
```csv
user,week,day,mode,n_events,malicious_ratio,email_ratio,file_ratio,duration_minutes,...
ACM2278,0,2024-01-15,day,12,0.0,0.4,0.2,480,...
ACM2278,0,2024-01-16,day,18,0.0,0.3,0.3,510,...
```

### 3. ä¼šè¯çº§åˆ«åˆ†æ (Session Level)

```python
# æ‰§è¡Œä¼šè¯çº§åˆ«åˆ†æ
pipeline.run_full_pipeline(start_week=0, end_week=10, modes=['session'])
```

**è¾“å‡ºæ–‡ä»¶**: `SessionLevelFeatures/sessions_0_9.csv`

**ç‰¹å¾å†…å®¹**:
- ç”¨æˆ·ä¼šè¯çš„æŒç»­æ—¶é—´
- ä¼šè¯å†…æ´»åŠ¨å¯†åº¦
- ä¼šè¯çº§åˆ«çš„è¡Œä¸ºæ¨¡å¼

**æ•°æ®æ ¼å¼**:
```csv
user,week,session_id,mode,n_events,duration_minutes,malicious_ratio,unique_event_types,...
ACM2278,0,0,session,8,120,0.0,3,...
ACM2278,0,1,session,15,240,0.1,4,...
```

## ğŸ”§ é«˜çº§é…ç½®

### è‡ªå®šä¹‰ä¼šè¯è¯†åˆ«

```python
# ä¿®æ”¹ä¼šè¯é—´éš”é˜ˆå€¼ï¼ˆé»˜è®¤60åˆ†é’Ÿï¼‰
def custom_session_analysis():
    pipeline = CERTDatasetPipeline()
    
    # åœ¨_identify_sessionsæ–¹æ³•ä¸­ä¿®æ”¹gap_thresholdå‚æ•°
    # gap_threshold=30  # 30åˆ†é’Ÿæ— æ´»åŠ¨åˆ™åˆ†å‰²ä¼šè¯
    # gap_threshold=120 # 2å°æ—¶æ— æ´»åŠ¨åˆ™åˆ†å‰²ä¼šè¯
```

### é€‰æ‹©æ€§æ¨¡å¼æ‰§è¡Œ

```python
# åªæ‰§è¡Œç‰¹å®šåˆ†ææ¨¡å¼
pipeline.run_full_pipeline(
    start_week=0, 
    end_week=5, 
    modes=['session']  # åªæ‰§è¡Œä¼šè¯çº§åˆ«åˆ†æ
)

# æ‰§è¡Œå¤šç§æ¨¡å¼
pipeline.run_full_pipeline(
    start_week=0, 
    end_week=10, 
    modes=['week', 'day']  # æ‰§è¡Œå‘¨çº§åˆ«å’Œæ—¥çº§åˆ«åˆ†æ
)
```

### ç”¨æˆ·å­é›†åˆ†æ

```python
# é™åˆ¶åˆ†æç”¨æˆ·æ•°é‡ï¼ˆè‡ªåŠ¨ä¿ç•™æ‰€æœ‰æ¶æ„ç”¨æˆ·ï¼‰
pipeline.run_full_pipeline(
    start_week=0, 
    end_week=10, 
    max_users=100,  # æœ€å¤š100ä¸ªç”¨æˆ·
    modes=['week', 'day', 'session']
)
```

## ğŸ“ è¾“å‡ºæ–‡ä»¶ç»“æ„

(æ­¤ç»“æ„ä¸ºç¤ºä¾‹ï¼Œå…·ä½“è·¯å¾„å–å†³äº `dataset_pipeline.py` çš„ `work_dir` é…ç½®)
```
feature_extraction_scenario/
â”œâ”€â”€ core_logic/
â”‚   â”œâ”€â”€ dataset_pipeline.py              # å®Œæ•´æµæ°´çº¿
â”‚   â”œâ”€â”€ encoder.py                       # ç»Ÿä¸€ç¼–ç å™¨
â”‚   â””â”€â”€ ... (å…¶ä»–æ ¸å¿ƒé€»è¾‘æ¨¡å—)
â”œâ”€â”€ docs/                                # æ–‡æ¡£ (æœ¬æ–‡ä»¶æ‰€åœ¨ç›®å½•)
â”œâ”€â”€ output/                              # (è¢« .gitignore å¿½ç•¥)
â”‚   â”œâ”€â”€ DataByWeek/                      # æŒ‰å‘¨åˆå¹¶çš„åŸå§‹æ•°æ® (å¦‚æœ work_dir æŒ‡å‘è¿™é‡Œ)
â”‚   â”œâ”€â”€ NumDataByWeek/                   # æ•°å€¼åŒ–ç‰¹å¾æ•°æ® (å¦‚æœ work_dir æŒ‡å‘è¿™é‡Œ)
â”‚   â”œâ”€â”€ WeekLevelFeatures/               # å‘¨çº§åˆ«åˆ†æç»“æœ (å¦‚æœ work_dir æŒ‡å‘è¿™é‡Œ)
â”‚   â”œâ”€â”€ DayLevelFeatures/                # æ—¥çº§åˆ«åˆ†æç»“æœ (å¦‚æœ work_dir æŒ‡å‘è¿™é‡Œ)
â”‚   â”œâ”€â”€ SessionLevelFeatures/            # ä¼šè¯çº§åˆ«åˆ†æç»“æœ (å¦‚æœ work_dir æŒ‡å‘è¿™é‡Œ)
â”‚   â””â”€â”€ ExtractedData/                   # å…¶ä»–å¯¼å‡ºæ•°æ® (å¦‚æœ work_dir æŒ‡å‘è¿™é‡Œ)
â”œâ”€â”€ tests/
â”‚   â””â”€â”€ test_pipeline.py                 # æµ‹è¯•è„šæœ¬ï¼Œå…¶è¾“å‡ºåœ¨ feature_extraction_scenario/test_output/
â””â”€â”€ README.md                            # é¡¹ç›®ä¸»README
```

## ğŸ” ç‰¹å¾å¯¹æ¯”åˆ†æ

### æ–°ç³»ç»Ÿä¼˜åŠ¿

1. **æ¨¡å—åŒ–è®¾è®¡**: æ¯ä¸ªåŠŸèƒ½æ¨¡å—ç‹¬ç«‹ï¼Œæ˜“äºç»´æŠ¤å’Œæ‰©å±•
2. **ç»Ÿä¸€æ¥å£**: EventEncoderæä¾›ä¸€è‡´çš„ç¼–ç æ¥å£
3. **ç‰ˆæœ¬å…¼å®¹**: è‡ªåŠ¨é€‚é…ä¸åŒCERTæ•°æ®é›†ç‰ˆæœ¬
4. **maskæœºåˆ¶**: æ™ºèƒ½å¤„ç†ç¼ºå¤±æ•°æ®
5. **å¼‚å¸¸æ£€æµ‹**: å†…ç½®å¤šç§å¯ç–‘æ¨¡å¼è¯†åˆ«

### ç‰¹å¾ç»´åº¦å¯¹æ¯”

| æ•°æ®ç‰ˆæœ¬ | åŸå§‹ç³»ç»Ÿç‰¹å¾æ•° | æ–°ç³»ç»Ÿç‰¹å¾æ•° | æå‡ |
|---------|---------------|-------------|------|
| r4.2 | 27åˆ— | 256ç»´å‘é‡ | 9.5x |
| r5.2 | 45åˆ— | 256ç»´å‘é‡ | 5.7x |
| r6.2 | 46åˆ— | 256ç»´å‘é‡ | 5.6x |

## ğŸ’¡ ä½¿ç”¨å»ºè®®

### 1. æ¸è¿›å¼å¤„ç†

```bash
# å…ˆå¤„ç†å°‘é‡å‘¨æ•°éªŒè¯ç³»ç»Ÿ
python dataset_pipeline.py 8 0 3 50 "week"

# å†æ‰©å±•åˆ°æ›´å¤§è§„æ¨¡
python dataset_pipeline.py 16 0 10 200 "week,day"

# æœ€åæ‰§è¡Œå®Œæ•´åˆ†æ
python dataset_pipeline.py 32 0 73 None "week,day,session"
```

### 2. èµ„æºä¼˜åŒ–

```python
# å¯¹äºå¤§è§„æ¨¡æ•°æ®é›†
pipeline = CERTDatasetPipeline(
    data_version='r5.2',
    feature_dim=128,  # å‡å°‘å‘é‡ç»´åº¦
    num_cores=16      # å¢åŠ å¹¶è¡Œåº¦
)
```

### 3. ç»“æœéªŒè¯

```python
# æ£€æŸ¥è¾“å‡ºæ–‡ä»¶
import pandas as pd

# è¯»å–å‘¨çº§åˆ«ç»“æœ
week_df = pd.read_csv('WeekLevelFeatures/weeks_0_9.csv')
print(f"å‘¨çº§åˆ«æ•°æ®: {len(week_df)} æ¡è®°å½•")
print(f"ç”¨æˆ·æ•°: {week_df['user'].nunique()}")
print(f"æ¶æ„æ¯”ä¾‹: {week_df['malicious_ratio'].mean():.3f}")

# æ£€æŸ¥ç‰¹å¾åˆ†å¸ƒ
feature_cols = [col for col in week_df.columns if col.startswith('mean_feature_')]
print(f"ç‰¹å¾ç»´åº¦: {len(feature_cols)}")
```

## ğŸš¨ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **åŸå§‹æ•°æ®æ–‡ä»¶ç¼ºå¤±**
```bash
FileNotFoundError: ç¼ºå¤±åŸå§‹æ•°æ®æ–‡ä»¶: ['email.csv', 'file.csv']
```
**è§£å†³**: ç¡®ä¿åœ¨æ­£ç¡®çš„CERTæ•°æ®é›†ç›®å½•ä¸‹è¿è¡Œï¼ŒåŒ…å«æ‰€æœ‰CSVæ–‡ä»¶

2. **å†…å­˜ä¸è¶³**
```bash
MemoryError: Unable to allocate array
```
**è§£å†³**: å‡å°‘`max_users`å‚æ•°æˆ–å¢åŠ ç³»ç»Ÿå†…å­˜

3. **ç¼–ç å™¨æ‹Ÿåˆå¤±è´¥**
```bash
ValueError: ç¼–ç å™¨æœªæ‹Ÿåˆï¼Œè¯·å…ˆè°ƒç”¨fit()æ–¹æ³•
```
**è§£å†³**: ç¡®ä¿è®­ç»ƒæ•°æ®ä¸ä¸ºç©ºï¼Œæ£€æŸ¥æ•°æ®æ ¼å¼

### è°ƒè¯•æ¨¡å¼

```python
# å¯ç”¨è¯¦ç»†æ—¥å¿—
import logging
logging.basicConfig(level=logging.DEBUG)

# å°è§„æ¨¡æµ‹è¯•
pipeline = CERTDatasetPipeline(data_version='r4.2')
pipeline.run_full_pipeline(
    start_week=0, 
    end_week=2,      # åªå¤„ç†2å‘¨
    max_users=10,    # åªå¤„ç†10ä¸ªç”¨æˆ·
    modes=['week']   # åªæ‰§è¡Œå‘¨çº§åˆ«åˆ†æ
)
```

## ğŸ‰ æ€»ç»“

æ–°çš„`dataset_pipeline.py`å®Œæ•´å®ç°äº†åŸå§‹`feature_extraction.py`çš„æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½ï¼Œå¹¶åœ¨ä»¥ä¸‹æ–¹é¢å®ç°äº†æ˜¾è‘—æå‡ï¼š

- **âœ… æ¨¡å—åŒ–æ¶æ„** - æ›´å¥½çš„ä»£ç ç»„ç»‡å’Œç»´æŠ¤æ€§
- **âœ… ç»Ÿä¸€ç¼–ç ** - ä¸€è‡´çš„ç‰¹å¾è¡¨ç¤ºæ ¼å¼
- **âœ… å¤šçº§åˆ«åˆ†æ** - å‘¨/æ—¥/ä¼šè¯çº§åˆ«çš„å®Œæ•´æ”¯æŒ
- **âœ… æ™ºèƒ½å¤„ç†** - è‡ªåŠ¨å¤„ç†ç¼ºå¤±æ•°æ®å’Œç‰ˆæœ¬å·®å¼‚
- **âœ… å¢å¼ºç‰¹å¾** - æ›´ä¸°å¯Œçš„ç‰¹å¾ç»´åº¦å’Œå¼‚å¸¸æ£€æµ‹

ç°åœ¨ä½ å¯ä»¥å®Œæ•´åœ°æ›¿ä»£åŸå§‹ç‰¹å¾æå–ç³»ç»Ÿï¼Œè·å¾—æ›´å¼ºå¤§å’Œçµæ´»çš„å†…éƒ¨å¨èƒæ£€æµ‹ç‰¹å¾æå–èƒ½åŠ›ï¼ 